<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Explanation Acceptance Pilot – Survey</title>
<style>
  :root{
    --bg: #0b0d10;
    --panel: #12151a;
    --card: #171b21;
    --muted: #99a3ad;
    --text: #e6edf3;
    --accent: #48a6ff;
    --accent-2:#7bd389;
    --danger:#ff6b6b;
    --border: #2a2f36;
    --focus: #79c0ff55;
  }
  @media (prefers-color-scheme: light) {
    :root{
      --bg: #f6f8fb;
      --panel: #ffffff;
      --card: #ffffff;
      --muted: #4b5563;
      --text: #0f172a;
      --accent: #2563eb;
      --accent-2:#16a34a;
      --danger:#dc2626;
      --border: #e5e7eb;
      --focus: #2563eb33;
    }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font:16px/1.55 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    color:var(--text);
    background:linear-gradient(180deg, var(--bg), #0b0d1000 60%), radial-gradient(1000px 500px at 90% -50%, #1d2a3a55, transparent), radial-gradient(1000px 500px at 10% 120%, #1a2f2155, transparent), var(--bg);
  }
  .wrap{
    max-width: 980px;
    margin: 32px auto;
    padding: 0 16px 64px;
  }
  header{
    display:flex; align-items:center; justify-content:space-between;
    gap:16px; margin-bottom:16px;
  }
  h1{font-size:1.4rem; margin:0}
  .badge{font-size:.85rem; color:var(--muted)}
  .panel{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:16px;
    box-shadow: 0 10px 30px #00000025;
    overflow:hidden;
  }
  .panel-head{
    padding:16px 20px; border-bottom:1px solid var(--border);
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .panel-body{padding:16px 20px}
  details.settings{margin-bottom:16px}
  details > summary{
    cursor:pointer; list-style:none; padding:12px 14px; border-radius:10px;
    background:var(--card); border:1px solid var(--border); color:var(--text);
    font-weight:600;
  }
  details[open] > summary{border-bottom-left-radius:0; border-bottom-right-radius:0}
  details .content{
    border:1px solid var(--border); border-top:none; border-bottom-left-radius:10px; border-bottom-right-radius:10px;
    background:var(--card); padding:12px;
  }
  .row{display:grid; gap:12px}
  @media (min-width:800px){ .row.two{grid-template-columns: 1fr 1fr} }
  textarea,input[type="text"]{
    width:100%; padding:12px 14px; border-radius:10px; border:1px solid var(--border);
    background:transparent; color:var(--text);
    outline:none;
  }
  textarea{min-height:120px; resize:vertical}
  textarea.mono{font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; min-height:140px}
  label{font-weight:600; color:var(--muted); display:block; margin-bottom:6px}
  .btn{
    appearance:none; border:none; padding:10px 14px; border-radius:10px; font-weight:600;
    cursor:pointer; color:#fff; background:var(--accent);
    transition: transform .04s ease, filter .2s ease; box-shadow: 0 6px 20px #2563eb33;
  }
  .btn.secondary{background:#2f3542; color:#dbe5ef; box-shadow:none}
  .btn.ghost{background:transparent; color:var(--muted); border:1px dashed var(--border)}
  .btn.success{background:var(--accent-2)}
  .btn.danger{background:var(--danger)}
  .btn:active{transform: translateY(1px)}
  .btn + .btn{margin-left:8px}
  .actions{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
  .list{border:1px dashed var(--border); border-radius:12px; padding:12px}
  .item{border:1px solid var(--border); border-radius:12px; padding:12px; background:var(--card); margin-bottom:10px}
  .item:last-child{margin-bottom:0}
  .muted{color:var(--muted); font-size:.95rem}
  .hint{font-size:.9rem; color:var(--muted)}
  .switch{
    display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--border);
    border-radius:999px; background:var(--card)
  }
  .switch input{accent-color: var(--accent)}
  .progress{
    height:8px; background:#0f1520; border:1px solid var(--border); border-radius:999px; overflow:hidden; width:100%;
  }
  .progress > span{display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent-2))}
  .survey-card{
    background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px 18px; margin-top:16px;
  }
  .kq{display:grid; gap:10px}
  .kq .label{font-weight:700}
  .claim, .explanation{
    border-left:3px solid var(--accent); padding-left:12px;
    background: linear-gradient(90deg, #3a4b5a10, transparent);
  }
  .grid-qs{display:grid; gap:16px; margin-top:8px}
  @media (min-width:760px){ .grid-qs{grid-template-columns: 1fr 1fr} }
  fieldset{border:1px solid var(--border); border-radius:12px; padding:10px 12px; min-inline-size:auto}
  legend{padding:0 6px; color:var(--muted); font-weight:700}
  .likert{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:6px}
  .likert label{font-weight:500; color:var(--text); margin:0}
  .likert input{accent-color: var(--accent)}
  .desc-ends{display:flex; justify-content:space-between; font-size:.85rem; color:var(--muted); margin-top:4px}
  .nav{
    display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:16px
  }
  .pill{font-size:.85rem; padding:6px 10px; border-radius:999px; border:1px solid var(--border); color:var(--muted)}
  .center{display:flex; justify-content:center; align-items:center}
  .footer-actions{display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:flex-end; margin-top:14px}
  .sr-only {
    position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
  }
  .small{font-size:.9rem}
  .inline{display:inline}
  .spacer{height:6px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Explanation Acceptance Pilot <span class="badge">v1</span></h1>
      <div class="muted small">Ask participants if the explanation “makes sense” and how convincing/clear it is. Internally you’ll compare with metric scores.</div>
    </div>
    <div class="actions">
      <button id="btnToggleAdmin" class="btn secondary" type="button">Toggle Admin</button>
    </div>
  </header>

  <!-- ADMIN / SETUP -->
  <section id="admin" class="panel">
    <div class="panel-head">
      <strong>Admin Mode</strong>
      <span class="muted small">Prepare items, then launch the survey. Nothing is uploaded; all runs locally.</span>
    </div>
    <div class="panel-body">
      <details class="settings" open>
        <summary>① Paste JSON items (optional)</summary>
        <div class="content">
          <div class="row">
            <label for="jsonInput">JSON array of items <span class="muted">(fields: id?, claim, explanation, model_answer?)</span></label>
            <textarea id="jsonInput" class="mono" placeholder='[
  {"id":"ex1","claim":"Lightning can strike the same place twice.","model_answer":"TRUE","explanation":"Tall structures attract repeated strikes..."},
  {"id":"ex2","claim":"Reindeer can fly.","model_answer":"FALSE","explanation":"No biological basis for flight in reindeer..."}
]'></textarea>
          </div>
          <div class="actions" style="margin-top:10px">
            <button type="button" class="btn" id="btnLoadJSON">Load JSON</button>
            <button type="button" class="btn ghost" id="btnClearJSON">Clear</button>
          </div>
        </div>
      </details>

      <details class="settings">
        <summary>② Or add items with the mini builder</summary>
        <div class="content">
          <div class="row">
            <div class="row two">
              <div>
                <label for="bClaim">Claim / Question</label>
                <textarea id="bClaim" placeholder="Type the claim or question shown to participants"></textarea>
              </div>
              <div>
                <label for="bAnswer">Model Answer <span class="muted">(optional: TRUE/FALSE, Yes/No, etc.)</span></label>
                <input id="bAnswer" type="text" placeholder="e.g., TRUE" />
              </div>
            </div>
            <div>
              <label for="bExplanation">Explanation (CoT or argLLM)</label>
              <textarea id="bExplanation" placeholder="Paste the generated explanation here"></textarea>
            </div>
          </div>
          <div class="actions" style="margin-top:10px">
            <button type="button" class="btn" id="btnAddItem">Add item</button>
            <button type="button" class="btn ghost" id="btnClearBuilder">Reset fields</button>
          </div>
          <div class="spacer"></div>
          <div class="muted small">Current items:</div>
          <div id="builderList" class="list"></div>
        </div>
      </details>

      <details class="settings">
        <summary>③ Survey settings</summary>
        <div class="content">
          <div class="actions">
            <label class="switch"><input id="optRandomize" type="checkbox" checked /> Randomize item order</label>
            <label class="switch"><input id="optRequire" type="checkbox" checked /> Require answers before Next</label>
            <label class="switch"><input id="optAnonym" type="checkbox" /> Hide model answer from participants</label>
          </div>
          <div class="hint" style="margin-top:8px">These preferences are saved locally for this browser.</div>
        </div>
      </details>

      <div class="actions" style="margin-top:10px">
        <button type="button" class="btn success" id="btnLaunch">Launch Survey</button>
        <button type="button" class="btn ghost" id="btnWipeAll">Wipe Local Save</button>
      </div>
    </div>
  </section>

  <!-- SURVEY -->
  <section id="survey" class="panel" style="display:none">
    <div class="panel-head">
      <strong>Participant View</strong>
      <div class="progress" aria-label="Progress"><span id="progressBar"></span></div>
    </div>
    <div class="panel-body" id="surveyBody">
      <!-- Intro screen -->
      <div id="intro">
        <div class="survey-card">
          <h2 style="margin:8px 0 6px">Welcome</h2>
          <p class="muted">You’ll see short explanations that accompany a claim/answer. Please judge whether each explanation “makes sense” to you, and how convincing and clear it is.</p>
          <div class="row two" style="margin-top:10px">
            <div>
              <label for="participantId">Participant ID (or initials)</label>
              <input id="participantId" type="text" placeholder="e.g., A12 or initials" />
            </div>
            <div>
              <label for="participantBg">Background (optional)</label>
              <input id="participantBg" type="text" placeholder="e.g., Biology, Computer Science, Non-technical" />
            </div>
          </div>
          <div style="margin-top:10px">
            <label class="switch"><input id="consentChk" type="checkbox" /> I consent to my anonymous responses being used for research.</label>
          </div>
          <div class="footer-actions">
            <button class="btn" id="btnStart">Start</button>
          </div>
        </div>
      </div>

      <!-- Item screen -->
      <div id="itemScreen" style="display:none">
        <div class="pill small" id="itemMeta">Item</div>
        <div class="survey-card">
          <div class="kq">
            <div>
              <div class="label">Claim / Question</div>
              <div class="claim" id="claimText"></div>
            </div>
            <div id="modelAnsWrap">
              <div class="label">Model Answer</div>
              <div class="claim" id="answerText"></div>
            </div>
            <div>
              <div class="label">Explanation</div>
              <div class="explanation" id="explanationText"></div>
            </div>
          </div>

          <div class="grid-qs" style="margin-top:12px">
            <fieldset>
              <legend>Do you buy this explanation?</legend>
              <div>
                <label><input type="radio" name="buy" value="Yes"> Yes</label>
                &nbsp;&nbsp;
                <label><input type="radio" name="buy" value="No"> No</label>
                &nbsp;&nbsp;
                <label><input type="radio" name="buy" value="Unsure"> Unsure</label>
              </div>
            </fieldset>

            <fieldset>
              <legend>How convincing is this explanation?</legend>
              <div class="likert" role="radiogroup" aria-label="Convincingness">
                <label><input type="radio" name="conv" value="1"> 1</label>
                <label><input type="radio" name="conv" value="2"> 2</label>
                <label><input type="radio" name="conv" value="3"> 3</label>
                <label><input type="radio" name="conv" value="4"> 4</label>
                <label><input type="radio" name="conv" value="5"> 5</label>
              </div>
              <div class="desc-ends"><span>Not convincing</span><span>Extremely convincing</span></div>
            </fieldset>

            <fieldset>
              <legend>How clear is this explanation?</legend>
              <div class="likert" role="radiogroup" aria-label="Clarity">
                <label><input type="radio" name="clar" value="1"> 1</label>
                <label><input type="radio" name="clar" value="2"> 2</label>
                <label><input type="radio" name="clar" value="3"> 3</label>
                <label><input type="radio" name="clar" value="4"> 4</label>
                <label><input type="radio" name="clar" value="5"> 5</label>
              </div>
              <div class="desc-ends"><span>Very unclear</span><span>Very clear</span></div>
            </fieldset>

            <fieldset>
              <legend>Any issues you noticed? <span class="muted">(optional)</span></legend>
              <textarea id="freeText" placeholder="e.g., repetitive, circular, off-topic, missing step…"></textarea>
            </fieldset>
          </div>

          <div class="nav">
            <button class="btn secondary" id="btnPrev">&larr; Previous</button>
            <div class="muted small" id="timerReadout" aria-live="polite">Time on this item: 0s</div>
            <button class="btn" id="btnNext">Next &rarr;</button>
          </div>
        </div>
      </div>

      <!-- End screen -->
      <div id="endScreen" style="display:none">
        <div class="survey-card center" style="flex-direction:column; gap:10px">
          <h2 style="margin:4px 0">All done — thank you!</h2>
          <div class="muted">You can now download your responses.</div>
          <div class="actions" style="margin-top:6px">
            <button class="btn success" id="btnDownloadJSON">Download JSON</button>
            <button class="btn success" id="btnDownloadCSV">Download CSV</button>
            <button class="btn ghost" id="btnRestart">Restart</button>
          </div>
        </div>
      </div>

    </div>
  </section>
</div>

<script>
/* ---------- Storage Keys ---------- */
const LS_CONFIG = "pilot_config_v1";
const LS_RESP   = "pilot_resp_v1";

/* ---------- State ---------- */
let items = [];                 // [{id, claim, model_answer?, explanation}]
let order = [];                 // randomized indices
let responses = {};             // by itemIdx: { buy, conv, clar, text, t_sec }
let participant = { id:"", bg:"", consent:false };
let settings = { randomize:true, require:true, hideAnswer:false };
let cur = -1;                   // current index into order
let t0 = 0;                     // time start for current item
let tickInt = null;

/* ---------- Elements ---------- */
const adminEl = document.getElementById("admin");
const surveyEl = document.getElementById("survey");
const surveyBody = document.getElementById("surveyBody");

const btnToggleAdmin = document.getElementById("btnToggleAdmin");
const btnLaunch = document.getElementById("btnLaunch");
const btnWipeAll = document.getElementById("btnWipeAll");

const jsonInput = document.getElementById("jsonInput");
const btnLoadJSON = document.getElementById("btnLoadJSON");
const btnClearJSON = document.getElementById("btnClearJSON");

const bClaim = document.getElementById("bClaim");
const bAnswer = document.getElementById("bAnswer");
const bExplanation = document.getElementById("bExplanation");
const btnAddItem = document.getElementById("btnAddItem");
const btnClearBuilder = document.getElementById("btnClearBuilder");
const builderList = document.getElementById("builderList");

const optRandomize = document.getElementById("optRandomize");
const optRequire = document.getElementById("optRequire");
const optAnonym = document.getElementById("optAnonym");

const progressBar = document.getElementById("progressBar");

const intro = document.getElementById("intro");
const itemScreen = document.getElementById("itemScreen");
const endScreen = document.getElementById("endScreen");

const participantId = document.getElementById("participantId");
const participantBg = document.getElementById("participantBg");
const consentChk = document.getElementById("consentChk");
const btnStart = document.getElementById("btnStart");

const itemMeta = document.getElementById("itemMeta");
const claimText = document.getElementById("claimText");
const answerText = document.getElementById("answerText");
const explanationText = document.getElementById("explanationText");
const modelAnsWrap = document.getElementById("modelAnsWrap");
const timerReadout = document.getElementById("timerReadout");

const btnPrev = document.getElementById("btnPrev");
const btnNext = document.getElementById("btnNext");

const btnDownloadJSON = document.getElementById("btnDownloadJSON");
const btnDownloadCSV = document.getElementById("btnDownloadCSV");
const btnRestart = document.getElementById("btnRestart");

/* ---------- Utils ---------- */
function uid(){ return Math.random().toString(36).slice(2,9); }
function now(){ return Date.now(); }
function secs(ms){ return Math.round(ms/1000); }
function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
function saveAll(){
  const data = { items, order, responses, participant, settings, cur };
  localStorage.setItem(LS_CONFIG, JSON.stringify({items, settings}));
  localStorage.setItem(LS_RESP, JSON.stringify(data));
}
function wipeAll(){
  localStorage.removeItem(LS_CONFIG);
  localStorage.removeItem(LS_RESP);
  location.reload();
}
function loadSaved(){
  try{
    const conf = JSON.parse(localStorage.getItem(LS_CONFIG) || "{}");
    if(conf.items?.length){ items = conf.items; }
    if(conf.settings){ settings = {...settings, ...conf.settings}; }
    renderBuilderList();
    optRandomize.checked = settings.randomize;
    optRequire.checked = settings.require;
    optAnonym.checked = settings.hideAnswer;
  }catch(e){}
}

/* ---------- Admin actions ---------- */
btnToggleAdmin.addEventListener("click", () => {
  adminEl.style.display = (adminEl.style.display === "none") ? "" : "none";
});

btnLoadJSON.addEventListener("click", () => {
  try {
    const arr = JSON.parse(jsonInput.value.trim());
    if(!Array.isArray(arr)) throw new Error("JSON must be an array.");
    for(const it of arr){
      const clean = {
        id: it.id || uid(),
        claim: String(it.claim || "").trim(),
        model_answer: (it.model_answer==null?"":String(it.model_answer).trim()),
        explanation: String(it.explanation || "").trim()
      };
      if(!clean.claim || !clean.explanation) continue;
      items.push(clean);
    }
    renderBuilderList();
    jsonInput.value="";
    saveAll();
    alert("Items loaded.");
  } catch (e) {
    alert("Invalid JSON: " + e.message);
  }
});

btnClearJSON.addEventListener("click", () => jsonInput.value = "");

btnAddItem.addEventListener("click", () => {
  const claim = bClaim.value.trim();
  const explanation = bExplanation.value.trim();
  const model_answer = bAnswer.value.trim();
  if(!claim || !explanation){
    alert("Please enter both a Claim and an Explanation.");
    return;
  }
  items.push({ id: uid(), claim, model_answer, explanation });
  bClaim.value = ""; bAnswer.value=""; bExplanation.value="";
  renderBuilderList();
  saveAll();
});

btnClearBuilder.addEventListener("click", () => {
  bClaim.value = ""; bAnswer.value=""; bExplanation.value="";
});

optRandomize.addEventListener("change", () => { settings.randomize = optRandomize.checked; saveAll(); });
optRequire.addEventListener("change", () => { settings.require = optRequire.checked; saveAll(); });
optAnonym.addEventListener("change", () => { settings.hideAnswer = optAnonym.checked; saveAll(); });

btnWipeAll.addEventListener("click", () => {
  if(confirm("This will erase all locally saved items and responses for this survey in this browser. Continue?")){
    wipeAll();
  }
});

function renderBuilderList(){
  if(!items.length){
    builderList.innerHTML = `<div class="muted">No items yet. Add with the builder above or paste JSON.</div>`;
    return;
  }
  builderList.innerHTML = items.map((it,i)=>`
    <div class="item">
      <div class="small muted">#${i+1} — ID: <code>${it.id}</code></div>
      <div class="small"><strong>Claim:</strong> ${escapeHTML(it.claim)}</div>
      ${it.model_answer ? `<div class="small"><strong>Model Answer:</strong> ${escapeHTML(it.model_answer)}</div>` : ""}
      <div class="small"><strong>Explanation:</strong> ${escapeHTML(truncate(it.explanation, 200))}</div>
      <div class="actions" style="margin-top:6px">
        <button class="btn ghost" onclick="moveItem(${i},-1)" ${i===0?"disabled":""}>↑</button>
        <button class="btn ghost" onclick="moveItem(${i},1)" ${i===items.length-1?"disabled":""}>↓</button>
        <button class="btn danger" onclick="removeItem(${i})">Delete</button>
      </div>
    </div>
  `).join("");
}
function moveItem(i, dir){
  const j = clamp(i+dir,0,items.length-1);
  if(i===j) return;
  const tmp = items[i]; items[i] = items[j]; items[j] = tmp;
  renderBuilderList(); saveAll();
}
function removeItem(i){
  if(!confirm("Delete this item?")) return;
  items.splice(i,1);
  renderBuilderList(); saveAll();
}
function truncate(s, n){ return s.length <= n ? s : s.slice(0,n-3) + "…"; }
function escapeHTML(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ---------- Launch Survey ---------- */
btnLaunch.addEventListener("click", () => {
  if(!items.length){
    alert("No items found. Add some in Admin Mode first.");
    return;
  }
  // Prepare order
  order = Array.from(items.keys());
  if(settings.randomize){
    // Fisher-Yates
    for(let i=order.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [order[i],order[j]] = [order[j],order[i]];
    }
  }
  responses = {};
  participant = { id:"", bg:"", consent:false };
  cur = -1;
  saveAll();

  // Show survey
  adminEl.style.display = "none";
  surveyEl.style.display = "";
  intro.style.display = "";
  itemScreen.style.display = "none";
  endScreen.style.display = "none";
  updateProgress();
});

/* ---------- Intro ---------- */
btnStart.addEventListener("click", () => {
  const id = participantId.value.trim();
  const ok = consentChk.checked;
  if(!ok){ alert("Consent is required to proceed."); return; }
  if(!id){ if(!confirm("No Participant ID entered. Continue anonymously?")) return; }
  participant.id = id || "anon";
  participant.bg = participantBg.value.trim();
  participant.consent = true;
  saveAll();
  goTo(0);
});

/* ---------- Item Navigation ---------- */
btnPrev.addEventListener("click", () => {
  if(cur<=0) return;
  if(!commitCurrent()) return; // validate before moving
  goTo(cur-1);
});
btnNext.addEventListener("click", () => {
  if(!commitCurrent()) return; // validate current
  if(cur >= order.length-1){
    finish();
  } else {
    goTo(cur+1);
  }
});

function goTo(idx){
  stopTimer();
  cur = idx;
  const itemIdx = order[cur];
  const it = items[itemIdx];

  intro.style.display = "none";
  itemScreen.style.display = "";
  endScreen.style.display = "none";

  itemMeta.textContent = `Item ${cur+1} of ${order.length}`;
  claimText.innerHTML = escapeHTML(it.claim);
  if(settings.hideAnswer || !it.model_answer){
    modelAnsWrap.style.display = "none";
  } else {
    modelAnsWrap.style.display = "";
    answerText.textContent = it.model_answer;
  }
  explanationText.innerHTML = escapeHTML(it.explanation);

  // Restore previous answers if any
  const r = responses[itemIdx] || {};
  setRadio("buy", r.buy);
  setRadio("conv", r.conv);
  setRadio("clar", r.clar);
  document.getElementById("freeText").value = r.text || "";

  // Buttons
  btnPrev.disabled = (cur===0);

  // Start timer
  t0 = now();
  tickInt = setInterval(updateTimer, 1000);

  updateProgress();
}

function commitCurrent(){
  const itemIdx = order[cur];
  const buy = getRadio("buy");
  const conv = getRadio("conv");
  const clar = getRadio("clar");
  const text = document.getElementById("freeText").value.trim();

  if(settings.require && (!buy || !conv || !clar)){
    alert("Please answer the required questions (buy/convincing/clarity) before continuing.");
    return false;
  }

  const t_sec = (responses[itemIdx]?.t_sec || 0) + secs(now()-t0);
  responses[itemIdx] = { buy:buy||null, conv:conv||null, clar:clar||null, text, t_sec };
  saveAll();
  return true;
}

function finish(){
  stopTimer();
  itemScreen.style.display = "none";
  endScreen.style.display = "";
  updateProgress(100);
}

function stopTimer(){
  if(tickInt){ clearInterval(tickInt); tickInt = null; }
  if(cur>=0 && cur<order.length){
    // fold time-in-progress into saved response
    const itemIdx = order[cur];
    const t_sec = (responses[itemIdx]?.t_sec || 0) + secs(now()-t0);
    responses[itemIdx] = { ...(responses[itemIdx]||{}), t_sec };
    saveAll();
  }
}
function updateTimer(){
  const elapsed = secs(now()-t0);
  timerReadout.textContent = `Time on this item: ${elapsed}s`;
}

function setRadio(name, val){
  const nodes = document.querySelectorAll(`input[name="${name}"]`);
  nodes.forEach(n => n.checked = (val!=null && String(n.value)===String(val)));
}
function getRadio(name){
  const n = document.querySelector(`input[name="${name}"]:checked`);
  return n ? n.value : null;
}

function updateProgress(forcePct){
  const pct = (forcePct!=null) ? forcePct : (cur<0?0: Math.round(((cur)/order.length)*100));
  progressBar.style.width = pct + "%";
}

/* ---------- Downloads ---------- */
btnDownloadJSON.addEventListener("click", () => {
  const payload = exportPayload();
  downloadBlob(JSON.stringify(payload, null, 2), `survey_${payload.meta.started_at.replace(/[: ]/g,"-")}_${participant.id}.json`, "application/json");
});
btnDownloadCSV.addEventListener("click", () => {
  const {csv, filename} = toCSV();
  downloadBlob(csv, filename, "text/csv");
});
btnRestart.addEventListener("click", () => {
  if(confirm("Restart the survey (keep items, clear responses)?")){
    const keep = items.slice();
    const conf = {...settings};
    wipeAll();
    // reload with preserved items/settings
    localStorage.setItem(LS_CONFIG, JSON.stringify({items: keep, settings: conf}));
    location.reload();
  }
});

function exportPayload(){
  const started_at = new Date(parseInt(JSON.parse(localStorage.getItem(LS_RESP)||"{}").started_ts || Date.now(), 10)).toISOString().replace("T"," ").replace("Z","");
  const map = {};
  order.forEach((itemIdx, orderPos) => {
    map[items[itemIdx].id] = { order: orderPos+1, ...items[itemIdx], response: responses[itemIdx]||null };
  });
  return {
    meta: {
      survey: "Explanation Acceptance Pilot",
      version: "v1",
      started_at,
      finished_at: new Date().toISOString().replace("T"," ").replace("Z",""),
      participant,
      settings
    },
    order: order.map(i => items[i].id),
    data: map
  };
}

function toCSV(){
  const header = ["participant_id","participant_bg","item_order","item_id","claim","model_answer","explanation","buy","conv","clar","free_text","time_s"];
  const rows = [];
  const pid = participant.id || "";
  const pbg = participant.bg || "";
  order.forEach((itemIdx, k) => {
    const it = items[itemIdx];
    const r = responses[itemIdx] || {};
    rows.push([
      csvEscape(pid),
      csvEscape(pbg),
      k+1,
      csvEscape(it.id),
      csvEscape(it.claim),
      csvEscape(it.model_answer||""),
      csvEscape(it.explanation),
      csvEscape(r.buy||""),
      csvEscape(r.conv||""),
      csvEscape(r.clar||""),
      csvEscape(r.text||""),
      r.t_sec||0
    ].join(","));
  });
  const csv = header.join(",") + "\n" + rows.join("\n");
  const filename = `survey_${(new Date()).toISOString().slice(0,19).replace(/[:T]/g,"-")}_${participant.id||"anon"}.csv`;
  return {csv, filename};
}
function csvEscape(s){
  const str = String(s).replace(/\r?\n/g, " ").replace(/"/g,'""');
  return /[",\n]/.test(str) ? `"${str}"` : str;
}
function downloadBlob(content, filename, type){
  const blob = new Blob([content], {type});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 100);
}

/* ---------- Restore in-progress (if any) ---------- */
(function init(){
  loadSaved();
  try{
    const saved = JSON.parse(localStorage.getItem(LS_RESP) || "{}");
    if(saved.items?.length){
      items = saved.items;
      settings = {...settings, ...(saved.settings||{})};
      order = saved.order || Array.from(items.keys());
      responses = saved.responses || {};
      participant = saved.participant || participant;
      cur = typeof saved.cur === "number" ? saved.cur : -1;

      renderBuilderList();
      optRandomize.checked = settings.randomize;
      optRequire.checked = settings.require;
      optAnonym.checked = settings.hideAnswer;

      // If a previous session was mid-survey, offer to resume
      if(order.length && (cur>=0 || Object.keys(responses).length)){
        if(confirm("Resume in-progress survey?")){
          adminEl.style.display = "none";
          surveyEl.style.display = "";
          intro.style.display = cur<0 ? "" : "none";
          endScreen.style.display = "none";
          if(cur>=0){
            goTo(cur);
          }
        }
      }
    } else {
      // mark start timestamp for payload
      const s = JSON.parse(localStorage.getItem(LS_RESP) || "{}");
      s.started_ts = String(Date.now());
      localStorage.setItem(LS_RESP, JSON.stringify(s));
    }
  }catch(e){}
})();

/* ---------- Accessibility niceties ---------- */
document.addEventListener("keydown", (e) => {
  if(!surveyEl || surveyEl.style.display==="none") return;
  if(e.key==="ArrowRight"){ tryNext(); }
  if(e.key==="ArrowLeft"){ btnPrev.click(); }
});
function tryNext(){
  const focused = document.activeElement;
  if(focused && (focused.tagName==="TEXTAREA" || focused.tagName==="INPUT")) return;
  btnNext.click();
}

/* ---------- Helper: mark survey start time if not set ---------- */
(function ensureStartTS(){
  const saved = JSON.parse(localStorage.getItem(LS_RESP) || "{}");
  if(!saved.started_ts){
    saved.started_ts = String(Date.now());
    localStorage.setItem(LS_RESP, JSON.stringify(saved));
  }
})();

</script>
</body>
</html>
